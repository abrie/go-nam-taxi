<!DOCTYPE html>
<html>

<head>
    <style type="text/css">
        #map { 
            width:500px; 
            height:500px;
        }
    </style>
</head>

<body>
    <h1>#GoNamTaxi2015 Prototype Client</h1>

    <div>
        <span>Client identifier:</span>
        <span id="client_id">[?]</span>
        <span>Server tickUpdate:</span>
        <span id="update_id">[?]</span>
    </div>

    <div id="map"><div>

    <script type="text/javascript" defer>
        var ws = new WebSocket('ws://localhost:8080');
        var google_maps_browser_key = undefined;
        var clientId = undefined;

        function handleHello(json) {
            google_maps_browser_key = json.google_maps_browser_key;
            clientId = json.clientId;
            document.getElementById("client_id").innerHTML = clientId;
            loadMapAPI();
        }

        function handleUpdate(json) {
            document.getElementById("update_id").innerHTML = json.content;
        }

        var handlers = {
            0:handleHello,
            1:handleUpdate,
        }

        ws.onmessage = function(event) {
            json = JSON.parse(event.data);
            handlers[json.type](json);
        };

        function buildRequest(baseUrl, params) {
            var result = undefined;
            for (var name in params) {
                result = result === undefined ? baseUrl : result.concat("&");
                result = result.concat(name + "=" + params[name]);
            }

            return result;
        }

        function getApiKey() {
            return google_maps_browser_key;
        }

        function loadMapAPI() {
            var baseUrl = "https://maps.googleapis.com/maps/api/js?";
            var params = {
                'key': getApiKey(),
                'callback': "onMapAPILoaded",
                'libraries': ['drawing'].join(',')
            }
            
            var script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = buildRequest(baseUrl, params);

            document.body.appendChild(script);
        }

        var Map = undefined;
        function onMapAPILoaded() {
            var map = createMap();
            var draw = createDrawManager();

            draw.setMap(map);
            draw.addListener('polylinecomplete', function(poly) {
                var path = poly.getPath();

                var pathValues = [];
                for (var i = 0; i < path.getLength(); i++) {
                    pathValues.push(path.getAt(i).toUrlValue());
                }
                var pathString = pathValues.join('|');
                console.log(pathString);
            });

            Map = {
                map: map,
                draw: draw
            }
        }

        function createMap() {
            return new google.maps.Map(document.getElementById('map'), {
                center: {lat: -22.5700, lng:17.0836},
                zoom: 16 
            });
        }

        function createDrawManager() {
            // See example at: https://developers.google.com/maps/documentation/roads/snap
            // Enables the polyline drawing control. Click on the map to start drawing a
            // polyline. Each click will add a new vertice. Double-click to stop drawing.
            return new google.maps.drawing.DrawingManager({
                drawingMode: google.maps.drawing.OverlayType.POLYLINE,
                drawingControl: true,
                drawingControlOptions: {
                    position: google.maps.ControlPosition.TOP_CENTER,
                    drawingModes: [
                        google.maps.drawing.OverlayType.POLYLINE
                    ]
                },
                polylineOptions: {
                    strokeColor: '#696969',
                    strokeWeight: 2
                }
            });
        }

    </script>
</body>

</html>
